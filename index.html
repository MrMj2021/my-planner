<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ZENITH OS | Pro Productivity Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* ---------- RESET & VARIABLES ---------- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazirmatn', 'Inter', sans-serif; }
        
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --primary-dark: #4f46e5;
            --accent: #f43f5e; --success: #10b981; --warning: #f59e0b; --info: #0ea5e9;
            --bg-base: #f8fafc; --surface: rgba(255, 255, 255, 0.85);
            --surface-border: rgba(255, 255, 255, 0.5);
            --text-primary: #1e293b; --text-secondary: #64748b;
            --priority-low: #10b981; --priority-medium: #f59e0b; --priority-high: #ef4444;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            --radius-lg: 16px; --radius-md: 12px;
            --drawer-width: 280px;
            --header-height: 70px;
        }

        [data-theme="dark"] {
            --bg-base: #0f172a; --surface: rgba(30, 41, 59, 0.8);
            --surface-border: rgba(255, 255, 255, 0.05);
            --text-primary: #f1f5f9; --text-secondary: #94a3b8;
            --card-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.3);
        }

        body { background: var(--bg-base); color: var(--text-primary); transition: all 0.3s ease; overflow-x: hidden; }

        /* ---------- LAYOUT ---------- */
        .app-container { display: flex; min-height: 100vh; position: relative; }
        
        .sidebar {
            width: 260px; background: var(--surface); backdrop-filter: blur(12px);
            border-left: 1px solid var(--surface-border); display: flex; flex-direction: column;
            position: fixed; height: 100vh; z-index: 100;
            transition: transform 0.3s ease;
        }

        .main-content { 
            flex: 1; 
            margin-right: 260px; 
            padding: 2rem; 
            min-height: 100vh;
            transition: margin-right 0.3s ease;
        }

        /* ----- desktop menu toggle (hidden on mobile) ----- */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 200;
            background: var(--primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(99,102,241,0.4);
            cursor: pointer;
            border: none;
        }

        /* ---------- MOBILE HAMBURGER MENU & DRAWER ---------- */
        .hamburger {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            background: var(--primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(99,102,241,0.4);
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }
        .hamburger:hover { transform: scale(1.05); }

        .drawer {
            position: fixed;
            top: 0;
            right: calc(-1 * var(--drawer-width));
            width: var(--drawer-width);
            height: 100vh;
            background: var(--surface);
            backdrop-filter: blur(12px);
            border-left: 1px solid var(--surface-border);
            z-index: 1002;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            padding: 2rem 0;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .drawer.open {
            right: 0;
        }
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }
        .drawer .nav-item {
            margin: 4px 16px;
            border-radius: 12px;
        }

        /* ---------- RESPONSIVE BREAKPOINT (MOBILE) ---------- */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .menu-toggle {
                display: none !important;
            }
            .hamburger {
                display: flex;
            }
            .main-content {
                margin-right: 0;
                padding: 1rem 1rem 2rem 1rem;
                padding-top: calc(var(--header-height) + 1rem);
            }
            /* Adjust cards and grids for mobile */
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            .note-grid {
                grid-template-columns: 1fr !important;
            }
            .goals-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .goals-stats {
                width: 100%;
                justify-content: space-between;
            }
            .timer-display {
                font-size: 3rem !important;
            }
            .session-stats {
                flex-direction: column;
                gap: 0.5rem;
            }
            .goal-actions {
                flex-wrap: wrap;
            }
            .timer-controls {
                flex-wrap: wrap;
            }
            .command-palette .cp-box {
                width: 90%;
                margin: 0 auto;
            }
            .btn {
                padding: 12px 20px;
                min-height: 48px;
                width: 100%;
                text-align: center;
            }
            .task-item, .habit-row {
                padding: 12px;
            }
            input, select, textarea {
                font-size: 16px;
            }
            .weekly-table {
                min-width: 800px;
            }
            .cell-input {
                font-size: 0.75rem;
                padding: 2px;
            }
            .time-label {
                font-size: 0.7rem;
                width: 50px;
            }
            .weekly-table th, .weekly-table td {
                padding: 3px;
            }
            /* adjust assistant for mobile */
            .assistant-btn {
                bottom: 20px !important;
            }
            .chat-window {
                bottom: 80px !important;
                width: 280px !important;
                left: 10px !important;
            }
        }

        /* ---------- UI COMPONENTS (Enhanced) ---------- */
        .glass-card {
            background: var(--surface); backdrop-filter: blur(10px);
            border: 1px solid var(--surface-border); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--card-shadow); margin-bottom: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 0.6rem 1.2rem; border: none; border-radius: var(--radius-md);
            cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(99,102,241,0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(99,102,241,0.4); }

        .nav-item {
            padding: 1rem 1.5rem; cursor: pointer; display: flex; align-items: center; gap: 12px;
            color: var(--text-secondary); transition: 0.2s; border-radius: var(--radius-md); margin: 4px 12px;
        }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .nav-item:hover:not(.active) { background: rgba(99,102,241,0.05); }

        /* ---------- DASHBOARD SPECIFIC ---------- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .stat-card { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); }
        
        /* ---------- MODULES ---------- */
        .task-item { 
            display: flex; align-items: center; gap: 12px; padding: 1rem; 
            border-bottom: 1px solid var(--surface-border); transition: 0.2s;
        }
        .task-item:hover { background: rgba(99, 102, 241, 0.05); }
        .task-item.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

        .habit-row { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--surface-border); }
        .habit-streak { background: linear-gradient(45deg, #f43f5e, #fb923c); color: white; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; }

        .note-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .note-card { height: 200px; display: flex; flex-direction: column; cursor: pointer; transition: 0.3s; }
        .note-card:hover { transform: translateY(-5px); }
        
        /* ---------- GOALS MODULE ---------- */
        .goals-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .goals-stats { display: flex; gap: 1.5rem; }
        .goal-card { 
            background: var(--surface); backdrop-filter: blur(10px);
            border: 1px solid var(--surface-border); border-radius: var(--radius-lg);
            padding: 1.5rem; transition: 0.3s; position: relative; overflow: hidden;
        }
        .goal-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -10px rgba(0,0,0,0.2); }
        .goal-card.completed::after {
            content: "ğŸ‰"; font-size: 3rem; position: absolute; bottom: 10px; left: 10px; opacity: 0.3;
            animation: celebrate 0.5s ease infinite alternate;
        }
        @keyframes celebrate { from { transform: scale(0.8); } to { transform: scale(1.2); } }
        .goal-progress-container { height: 10px; background: var(--surface-border); border-radius: 20px; margin: 1rem 0; overflow: hidden; }
        .goal-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.5s ease; border-radius: 20px; }
        .goal-milestones { margin-top: 1rem; }
        .milestone-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; font-size: 0.9rem; }
        .milestone-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .goal-actions { display: flex; gap: 5px; margin-top: 1rem; justify-content: flex-end; }
        .goal-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 20px; background: var(--primary-light); color: white; display: inline-block; }

        /* ---------- FOCUS MODULE (Ù¾ÛŒØ´Ø±ÙØªÙ‡) ---------- */
        .focus-container { text-align: center; }
        .timer-display {
            font-size: 5rem; font-weight: 800; font-family: 'Inter', monospace;
            color: var(--primary); line-height: 1.2; margin: 1rem 0;
        }
        .timer-controls { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; flex-wrap: wrap; }
        .timer-progress { height: 8px; background: var(--surface-border); border-radius: 20px; margin: 1rem 0; overflow: hidden; }
        .timer-progress-fill { height: 100%; background: var(--primary); width: 100%; transition: width 0.1s linear; }
        .session-stats { display: flex; justify-content: space-around; margin: 2rem 0; }
        .session-card { text-align: center; padding: 1rem; background: var(--surface); border-radius: var(--radius-md); flex:1; margin:0 5px; }
        .session-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .session-label { font-size: 0.8rem; color: var(--text-secondary); }
        .session-list { max-height: 200px; overflow-y: auto; margin-top: 1rem; }
        .session-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px dashed var(--surface-border); }
        .timer-running { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity:1; } 50% { opacity:0.7; } }

        /* ---------- FOCUS ENHANCEMENTS ---------- */
        .focus-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .focus-presets {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .preset-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--surface-border);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            color: var(--primary);
            transition: 0.3s;
        }
        .preset-btn.active {
            background: var(--primary);
            color: white;
        }
        .xp-badge {
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            color: white;
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: inline-block;
        }

        /* ---------- WEEKLY SHEET STYLES ---------- */
        .sheet-outer-container {
            overflow-x: auto;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--surface-border);
            margin-top: 20px;
        }

        .weekly-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        .weekly-table th, .weekly-table td {
            border: 1px solid var(--surface-border);
            padding: 5px;
            height: 50px;
        }

        .weekly-table th {
            background: #f8fafc;
            font-weight: bold;
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        .time-label {
            background: #f1f5f9;
            font-weight: bold;
            width: 70px;
            font-size: 0.8rem;
            text-align: center;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background: transparent;
            text-align: center;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .cell-input:focus {
            background: #e0e7ff;
            border-radius: 4px;
        }

        /* ---------- ASSISTANT (SUPER COOL UI & SUPER INTELLIGENT) ---------- */
        .assistant-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
            z-index: 1000;
            animation: float 3s ease-in-out infinite;
            border: none;
            transition: transform 0.2s;
        }
        .assistant-btn:hover {
            transform: scale(1.1) rotate(5deg);
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }

        .chat-window {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 340px;
            max-height: 500px;
            background: var(--surface);
            backdrop-filter: blur(15px);
            border-radius: 24px;
            display: none;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            z-index: 1000;
            border: 1px solid var(--surface-border);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .chat-window .chat-header {
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 1.1rem;
        }
        .chat-window .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: slideIn 0.3s ease;
        }
        .message.user {
            align-self: flex-end;
        }
        .message.bot {
            align-self: flex-start;
        }
        .message .bubble {
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .message.user .bubble {
            background: var(--primary);
            color: white;
            border-bottom-left-radius: 4px;
        }
        .message.bot .bubble {
            background: var(--surface);
            border: 1px solid var(--surface-border);
            color: var(--text-primary);
            border-bottom-right-radius: 4px;
        }
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 12px 16px;
            background: var(--surface);
            border: 1px solid var(--surface-border);
            border-radius: 20px;
            width: fit-content;
            margin-bottom: 5px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-window .chat-input-area {
            display: flex;
            padding: 15px;
            gap: 10px;
            border-top: 1px solid var(--surface-border);
            background: var(--surface);
        }
        .chat-window .chat-input-area input {
            flex: 1;
            border-radius: 30px;
            border: 1px solid var(--surface-border);
            padding: 12px 18px;
            font-size: 0.95rem;
            background: var(--bg-base);
            color: var(--text-primary);
            outline: none;
            transition: border 0.2s;
        }
        .chat-window .chat-input-area input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99,102,241,0.2);
        }
        .chat-window .chat-input-area button {
            margin: 0;
            padding: 12px 20px;
            border-radius: 30px;
            background: var(--primary);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 10px rgba(99,102,241,0.3);
        }
        .chat-window .chat-input-area button:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* ---------- COMMAND PALETTE ---------- */
        .command-palette {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: flex-start; padding-top: 10vh; z-index: 1000;
        }
        .command-palette.open { display: flex; }
        .cp-box { width: 600px; background: var(--surface); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .cp-input { width: 100%; padding: 1.2rem; border: none; background: transparent; color: var(--text-primary); outline: none; font-size: 1.1rem; }

        /* ---------- ANIMATIONS ---------- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <!-- Desktop sidebar -->
        <aside class="sidebar" id="sidebar">
            <div style="padding: 2rem; text-align: center;">
                <h1 style="font-size: 1.5rem; color: var(--primary); font-weight: 900;">ZENITH OS</h1>
                <p style="font-size: 0.75rem; color: var(--text-secondary);">Productivity Reinvented</p>
            </div>
            <nav id="main-nav">
                <div class="nav-item active" data-view="dashboard"><span>ğŸ </span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
                <div class="nav-item" data-view="tasks"><span>âœ…</span> ÙˆØ¸Ø§ÛŒÙ</div>
                <div class="nav-item" data-view="habits"><span>ğŸ”¥</span> Ø¹Ø§Ø¯Ø§Øª</div>
                <div class="nav-item" data-view="notes"><span>ğŸ“</span> ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</div>
                <div class="nav-item" data-view="goals"><span>ğŸ¯</span> Ø§Ù‡Ø¯Ø§Ù</div>
                <div class="nav-item" data-view="focus"><span>â±ï¸</span> ØªÙ…Ø±Ú©Ø²</div>
                <div class="nav-item" data-view="stats"><span>ğŸ“Š</span> Ø¢Ù…Ø§Ø±</div>
                <div class="nav-item" data-view="weekly"><span>ğŸ“…</span> Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</div>
            </nav>
            <div style="margin-top: auto; padding: 1.5rem; border-top: 1px solid var(--surface-border);">
                <button class="btn btn-primary" style="width: 100%;" onclick="app.toggleTheme()">ğŸŒ“ ØªØºÛŒÛŒØ± ØªÙ…</button>
                <p style="margin-top: 10px; font-size: 0.7rem; text-align: center; color: var(--text-secondary);">Ctrl + K Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª</p>
            </div>
        </aside>

        <!-- Mobile hamburger menu and drawer -->
        <button class="hamburger" id="hamburger" onclick="app.toggleDrawer()">â˜°</button>
        <div class="drawer-overlay" id="drawerOverlay" onclick="app.closeDrawer()"></div>
        <div class="drawer" id="drawer">
            <div style="padding: 2rem; text-align: center;">
                <h1 style="font-size: 1.5rem; color: var(--primary); font-weight: 900;">ZENITH OS</h1>
                <p style="font-size: 0.75rem; color: var(--text-secondary);">Productivity Reinvented</p>
            </div>
            <nav id="drawer-nav">
                <div class="nav-item active" data-view="dashboard"><span>ğŸ </span> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</div>
                <div class="nav-item" data-view="tasks"><span>âœ…</span> ÙˆØ¸Ø§ÛŒÙ</div>
                <div class="nav-item" data-view="habits"><span>ğŸ”¥</span> Ø¹Ø§Ø¯Ø§Øª</div>
                <div class="nav-item" data-view="notes"><span>ğŸ“</span> ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</div>
                <div class="nav-item" data-view="goals"><span>ğŸ¯</span> Ø§Ù‡Ø¯Ø§Ù</div>
                <div class="nav-item" data-view="focus"><span>â±ï¸</span> ØªÙ…Ø±Ú©Ø²</div>
                <div class="nav-item" data-view="stats"><span>ğŸ“Š</span> Ø¢Ù…Ø§Ø±</div>
                <div class="nav-item" data-view="weekly"><span>ğŸ“…</span> Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</div>
            </nav>
            <div style="margin-top: auto; padding: 1.5rem; border-top: 1px solid var(--surface-border);">
                <button class="btn btn-primary" style="width: 100%;" onclick="app.toggleTheme()">ğŸŒ“ ØªØºÛŒÛŒØ± ØªÙ…</button>
            </div>
        </div>

        <main class="main-content" id="app-view"></main>
    </div>

    <!-- desktop menu toggle (hidden on mobile) -->
    <button class="menu-toggle" id="menuToggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>

    <!-- Assistant UI -->
    <div class="assistant-btn" onclick="app.toggleChat()">ğŸ¤–</div>
    <div id="chat-window" class="chat-window">
        <div class="chat-header">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Zenith</div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input id="chat-input" type="text" placeholder="Ø¨Ù¾Ø±Ø³...">
            <button onclick="app.sendChatMessage()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <div class="command-palette" id="cmd-palette">
        <div class="cp-box">
            <input type="text" class="cp-input" id="cp-input" placeholder="Ø¯Ø³ØªÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§: 'Ø§ÙØ²ÙˆØ¯Ù† ØªØ³Ú© Ø®Ø±ÛŒØ¯ Ù†Ø§Ù†')...">
            <div id="cp-results" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
        </div>
    </div>

    <script type="module">
        // 1. Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHkZ0VZLWUy22PuHF2eVQAnXm4ESoTiBE",
            authDomain: "zenith-25ca4.firebaseapp.com",
            projectId: "zenith-25ca4",
            storageBucket: "zenith-25ca4.firebasestorage.app",
            messagingSenderId: "881002534991",
            appId: "1:881002534991:web:e3656fd0ed26c90266b23a",
            measurementId: "G-0PQ50GQJV9"
        };

        const fbApp = initializeApp(firebaseConfig);
        const db = getFirestore(fbApp);
        const docRef = doc(db, "zenith_data", "main_profile");

        const defaultState = {
            tasks: [],
            habits: [],
            notes: [],
            goals: [],
            reminders: [],
            focusTime: 0,
            history: { focus: [10, 25, 15, 45, 30, 20, 50] },
            lastVisit: null,
            focusSessions: [],
            xp: 0,
            weeklyData: {}
        };

        const app = {
            state: {
                currentView: 'dashboard',
                ...defaultState
            },
            charts: {},
            timer: { 
                totalSeconds: 25 * 60, 
                timeLeft: 25 * 60, 
                interval: null, 
                running: false,
                sessionStart: null
            },
            alarmInterval: null,
            isInitialLoad: false,
            // Assistant memory and context
            lastIntent: null,
            lastParams: {},
            conversationHistory: [], // store last few exchanges

            async save() {
                if (!this.isInitialLoad) {
                    console.log("â³ Initial load not yet complete, skipping save.");
                    return;
                }
                const dataToSave = { ...this.state };
                delete dataToSave.currentView;
                try {
                    await setDoc(docRef, dataToSave);
                    console.log("âœ… Synced to Firebase");
                } catch (error) {
                    console.error("âŒ Firebase save error:", error);
                }
            },

            async init() {
                this.toast("Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...", "info");
                
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        this.state = { 
                            ...this.state,
                            ...cloudData,
                            currentView: this.state.currentView 
                        };
                        this.isInitialLoad = true;
                    } else {
                        this.isInitialLoad = true;
                        this.save(); 
                    }
                    this.render();
                    this.updateActiveNav();
                });

                this.checkMidnightReset();
                this.attachEvents();
                this.startClock();
                this.startReminderChecker();

                // Close drawer on mobile after navigation
                document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        if (window.innerWidth <= 768) {
                            this.closeDrawer();
                        }
                    });
                });
            },

            toggleDrawer() {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawerOverlay');
                drawer.classList.toggle('open');
                overlay.classList.toggle('open');
            },
            closeDrawer() {
                const drawer = document.getElementById('drawer');
                const overlay = document.getElementById('drawerOverlay');
                drawer.classList.remove('open');
                overlay.classList.remove('open');
            },

            updateActiveNav() {
                const view = this.state.currentView;
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.dataset.view === view) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            },

            checkMidnightReset() {
                const today = new Date().toLocaleDateString('fa-IR');
                if (this.state.lastVisit !== today) {
                    this.state.habits.forEach(h => h.completedToday = false);
                    this.state.tasks = [];
                    this.state.lastVisit = today;
                    this.save();
                }
            },

            render() {
                const view = document.getElementById('app-view');
                if (!view) return;
                view.innerHTML = '';
                view.className = 'main-content fade-in';

                switch(this.state.currentView) {
                    case 'dashboard': this.renderDashboard(view); break;
                    case 'tasks': this.renderTasks(view); break;
                    case 'habits': this.renderHabits(view); break;
                    case 'notes': this.renderNotes(view); break;
                    case 'stats': this.renderStats(view); break;
                    case 'focus': this.renderFocus(view); break;
                    case 'goals': this.renderGoals(view); break;
                    case 'weekly': this.renderWeekly(view); break;
                }

                if (window.innerWidth <= 768) {
                    // nothing
                }
            },

            /* ---------- DASHBOARD ---------- */
            renderDashboard(container) {
                const completedTasks = this.state.tasks.filter(t => t.completed).length;
                const prodScore = this.calculateProductivityScore();
                
                container.innerHTML = `
                    <header style="display:flex; justify-content:space-between; align-items:center; mb: 2rem; flex-wrap:wrap; gap:1rem;">
                        <div>
                            <h2 style="font-size: 1.8rem;">Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ âœ¨</h2>
                            <p id="clock" style="color: var(--primary); font-weight: 700;"></p>
                        </div>
                        <div class="glass-card" style="padding: 0.5rem 1.5rem; text-align:center;">
                            <div style="font-size:0.7rem; color:var(--text-secondary);">Ø§Ù…ØªÛŒØ§Ø² Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ</div>
                            <div style="font-size:1.5rem; font-weight:800; color:${prodScore > 70 ? 'var(--success)' : 'var(--warning)'}">${prodScore}%</div>
                        </div>
                    </header>

                    <div class="stats-grid">
                        <div class="glass-card stat-card">
                            <div class="stat-value" id="taskCounter">0</div>
                            <div style="color: var(--text-secondary);">ÙˆØ¸Ø§ÛŒÙ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</div>
                        </div>
                        <div class="glass-card stat-card">
                            <div class="stat-value" id="habitCounter">0</div>
                            <div style="color: var(--text-secondary);">Ø¹Ø§Ø¯Ø§Øª ÙØ¹Ø§Ù„</div>
                        </div>
                        <div class="glass-card stat-card">
                            <div class="stat-value" id="focusCounter">0</div>
                            <div style="color: var(--text-secondary);">Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø² Ø§Ù…Ø±ÙˆØ²</div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div class="glass-card">
                            <h3>ÙˆØ¸Ø§ÛŒÙ Ø³Ø±ÛŒØ¹</h3>
                            <div style="display:flex; gap:10px; margin: 15px 0; flex-wrap:wrap;">
                                <input type="text" id="quickTaskInput" class="cp-input" style="border: 1px solid var(--surface-border); border-radius:10px; flex:1; min-width:150px;" placeholder="Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÛŒØ¹ ÙˆØ¸ÛŒÙÙ‡...">
                                <button id="quickAddTaskBtn" class="btn btn-primary">Ø§ÙØ²ÙˆØ¯Ù†</button>
                            </div>
                            <div id="dashboard-tasks"></div>
                        </div>
                        <div class="glass-card">
                            <h3>Ù†Ù‚Ù„ Ù‚ÙˆÙ„ Ø±ÙˆØ²</h3>
                            <p style="font-style:italic; margin-top:15px; color:var(--text-secondary);">"Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ø§Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ØŒ Ø³Ø§Ø®ØªÙ† Ø¢Ù† Ø§Ø³Øª."</p>
                        </div>
                    </div>

                    <div class="glass-card" style="margin-top: 1.5rem;">
                        <h3>ÛŒØ§Ø¯Ø¢ÙˆØ±Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</h3>
                        <div style="margin-top: 15px;">
                            ${this.state.reminders.map(r => `
                                <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--surface-border); flex-wrap:wrap;">
                                    <span><span style="font-weight:600; color:var(--primary);">${r.time}</span> - ${r.text}</span>
                                    <button class="btn" style="padding:2px 8px; color:var(--accent);" onclick="app.deleteReminder(${r.id})">ğŸ—‘ï¸</button>
                                </div>
                            `).join('')}
                            ${this.state.reminders.length === 0 ? '<p style="color:var(--text-secondary);">ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>' : ''}
                        </div>
                        <div style="display:flex; gap:5px; margin-top:15px; flex-wrap:wrap;">
                            <input type="text" id="reminder-text" placeholder="Ù…ØªÙ† ÛŒØ§Ø¯Ø¢ÙˆØ±..." style="flex:2; min-width:150px; background:var(--input-bg); border:1px solid var(--surface-border); border-radius:10px; padding:8px;">
                            <input type="time" id="reminder-time" style="flex:1; min-width:120px; background:var(--input-bg); border:1px solid var(--surface-border); border-radius:10px; padding:8px;">
                            <button class="btn btn-primary" onclick="app.addReminder(document.getElementById('reminder-text').value, document.getElementById('reminder-time').value)">â•</button>
                        </div>
                    </div>
                `;

                this.animateValue("taskCounter", 0, completedTasks, 1000);
                this.animateValue("habitCounter", 0, this.state.habits.length, 1000);
                this.animateValue("focusCounter", 0, this.totalFocusToday(), 1000);

                document.getElementById('quickAddTaskBtn').onclick = () => {
                    const val = document.getElementById('quickTaskInput').value;
                    if(val) this.addTask(val);
                };

                this.renderMiniTasks();
            },

            renderMiniTasks() {
                const list = document.getElementById('dashboard-tasks');
                const recent = this.state.tasks.slice(-5).reverse();
                list.innerHTML = recent.map(t => `
                    <div class="task-item" style="border:none; padding:8px 0;">
                        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="app.toggleTask(${t.id})">
                        <span style="${t.completed ? 'text-decoration:line-through; opacity:0.5' : ''}">${t.title}</span>
                    </div>
                `).join('') || '<p style="text-align:center; color:var(--text-secondary);">Ù„ÛŒØ³Øª Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</p>';
            },

            /* ---------- TASKS MODULE ---------- */
            renderTasks(container) {
                container.innerHTML = `
                    <div class="glass-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;">
                            <h2>Ù„ÛŒØ³Øª ÙˆØ¸Ø§ÛŒÙ</h2>
                            <button class="btn btn-primary" onclick="app.addTaskPrompt()">+ ÙˆØ¸ÛŒÙÙ‡ Ø¬Ø¯ÛŒØ¯</button>
                        </div>
                        <div id="task-list" style="margin-top: 20px;"></div>
                    </div>
                `;
                this.renderTaskList();
            },

            renderTaskList() {
                const list = document.getElementById('task-list');
                list.innerHTML = this.state.tasks.map((t, idx) => `
                    <div class="task-item" draggable="true" data-id="${t.id}" ondragstart="app.handleDragStart(event)">
                        <div style="width:4px; height:20px; background:var(--priority-${t.priority}); border-radius:2px;"></div>
                        <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="app.toggleTask(${t.id})">
                        <span style="flex:1; ${t.completed ? 'text-decoration:line-through; color:var(--text-secondary)' : ''}">${t.title}</span>
                        <button class="btn" style="color:var(--accent)" onclick="app.deleteTask(${t.id})">ğŸ—‘ï¸</button>
                    </div>
                `).join('');
            },

            handleDragStart(e) {
                e.dataTransfer.setData('text/plain', e.currentTarget.dataset.id);
                e.currentTarget.classList.add('dragging');
            },

            addTaskPrompt() {
                const title = prompt("Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡ Ø¬Ø¯ÛŒØ¯:");
                if (title) this.addTask(title);
            },

            /* ---------- HABITS MODULE ---------- */
            renderHabits(container) {
                container.innerHTML = `
                    <div class="glass-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; mb:1rem; flex-wrap:wrap; gap:1rem;">
                            <h2>Ø±Ø¯ÛŒØ§Ø¨ Ø¹Ø§Ø¯Ø§Øª</h2>
                            <button class="btn btn-primary" onclick="app.addHabitPrompt()">+ Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯</button>
                        </div>
                        <div id="habits-list"></div>
                    </div>
                `;
                this.renderHabitsList();
            },

            renderHabitsList() {
                const list = document.getElementById('habits-list');
                if (this.state.habits.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-secondary);">Ù‡Ù†ÙˆØ² Ø¹Ø§Ø¯ØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</div>`;
                    return;
                }

                list.innerHTML = this.state.habits.map(h => `
                    <div class="habit-row">
                        <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
                            <div class="habit-streak">ğŸ”¥ ${h.streak || 0}</div>
                            <div>
                                <div style="font-weight:700;">${h.name}</div>
                                <div style="font-size:0.75rem; color:var(--text-secondary);">Ø¢Ø®Ø±ÛŒÙ† ØªÛŒÚ©: ${h.lastDone || '---'}</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn ${h.completedToday ? 'btn-primary' : ''}" 
                                    style="border:1px solid var(--primary)" 
                                    onclick="app.toggleHabit(${h.id})">
                                ${h.completedToday ? 'âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯' : 'ØªÛŒÚ© Ø§Ù…Ø±ÙˆØ²'}
                            </button>
                            <button class="btn" style="color:var(--accent)" onclick="app.deleteHabit(${h.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            },

            addHabitPrompt() {
                const name = prompt("Ù†Ø§Ù… Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
                if (name) {
                    const newHabit = { id: Date.now(), name, streak: 0, completedToday: false, lastDone: null };
                    this.state.habits.push(newHabit);
                    this.save();
                    this.renderHabitsList();
                }
            },

            toggleHabit(id) {
                const h = this.state.habits.find(h => h.id === id);
                if (h) {
                    h.completedToday = !h.completedToday;
                    if (h.completedToday) {
                        h.streak++;
                        h.lastDone = new Date().toLocaleDateString('fa-IR');
                    } else {
                        h.streak--;
                    }
                    this.save();
                    this.renderHabitsList();
                }
            },

            deleteHabit(id) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¹Ø§Ø¯Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    this.state.habits = this.state.habits.filter(h => h.id !== id);
                    this.save();
                    this.renderHabitsList();
                }
            },

            /* ---------- NOTES MODULE ---------- */
            renderNotes(container) {
                container.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem; flex-wrap:wrap; gap:1rem;">
                        <h2>Ø¯ÙØªØ±Ú†Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h2>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <input type="text" id="noteSearch" class="cp-input" style="width:200px; border:1px solid var(--surface-border); border-radius:10px; padding:5px 15px;" placeholder="Ø¬Ø³ØªØ¬Ùˆ...">
                            <button class="btn btn-primary" onclick="app.addNote()">+ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯</button>
                        </div>
                    </div>
                    <div id="notes-grid" class="note-grid"></div>
                `;
                this.renderNotesList();
                document.getElementById('noteSearch').oninput = (e) => this.renderNotesList(e.target.value);
            },

            renderNotesList(filter = '') {
                const grid = document.getElementById('notes-grid');
                const filtered = this.state.notes.filter(n => n.title.includes(filter) || n.content.includes(filter));
                
                grid.innerHTML = filtered.map(n => `
                    <div class="glass-card note-card fade-in" onclick="app.editNote(${n.id})">
                        <h3 style="margin-bottom:10px;">${n.title}</h3>
                        <p style="font-size:0.85rem; color:var(--text-secondary); flex:1; overflow:hidden;">${n.content.substring(0, 100)}...</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; border-top:1px solid var(--surface-border); pt:10px;">
                            <span style="font-size:0.7rem;">${n.date}</span>
                            <button class="btn" style="color:var(--accent); padding:2px;" onclick="event.stopPropagation(); app.deleteNote(${n.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('') || '<p style="grid-column:1/-1; text-align:center;">ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
            },

            addNote() {
                const newNote = { id: Date.now(), title: 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†', content: '', date: new Date().toLocaleDateString('fa-IR') };
                this.state.notes.push(newNote);
                this.save();
                this.editNote(newNote.id);
            },

            editNote(id) {
                const n = this.state.notes.find(n => n.id === id);
                const view = document.getElementById('app-view');
                view.innerHTML = `
                    <div class="glass-card fade-in" style="height: 80vh; display:flex; flex-direction:column;">
                        <div style="display:flex; justify-content:space-between; align-items:center; mb:1rem; flex-wrap:wrap;">
                            <input type="text" id="editNoteTitle" value="${n.title}" style="background:transparent; border:none; font-size:1.5rem; font-weight:700; color:var(--text-primary); outline:none; width:70%; min-width:200px;">
                            <button class="btn btn-primary" onclick="app.state.currentView='notes'; app.render();">Ø¨Ø±Ú¯Ø´Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡</button>
                        </div>
                        <textarea id="editNoteContent" style="flex:1; background:transparent; border:none; resize:none; outline:none; color:var(--text-primary); font-size:1.1rem; line-height:1.6;">${n.content}</textarea>
                        <div id="autosave-indicator" style="font-size:0.7rem; text-align:right; color:var(--success); opacity:0;">Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ“</div>
                    </div>
                `;

                const titleInput = document.getElementById('editNoteTitle');
                const contentInput = document.getElementById('editNoteContent');
                
                const autoSave = () => {
                    n.title = titleInput.value;
                    n.content = contentInput.value;
                    this.save();
                    const ind = document.getElementById('autosave-indicator');
                    ind.style.opacity = '1';
                    setTimeout(() => ind.style.opacity = '0', 2000);
                };

                titleInput.oninput = autoSave;
                contentInput.oninput = autoSave;
            },

            deleteNote(id) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    this.state.notes = this.state.notes.filter(n => n.id !== id);
                    this.save();
                    this.renderNotesList();
                }
            },

            /* ---------- REMINDERS ---------- */
            addReminder(text, time) {
                if (!text || !time) {
                    this.toast('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ùˆ Ø²Ù…Ø§Ù† ÛŒØ§Ø¯Ø¢ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }
                const newReminder = { id: Date.now(), text, time };
                this.state.reminders.push(newReminder);
                this.save();
                this.toast('ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                document.getElementById('reminder-text').value = '';
                document.getElementById('reminder-time').value = '';
                this.render();
            },

            deleteReminder(id, confirmDelete = true) {
                if (confirmDelete && !confirm('Ø¢ÛŒØ§ ÛŒØ§Ø¯Ø¢ÙˆØ± Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
                this.state.reminders = this.state.reminders.filter(r => r.id !== id);
                this.save();
                if (confirmDelete) this.toast('ÛŒØ§Ø¯Ø¢ÙˆØ± Ø­Ø°Ù Ø´Ø¯');
                this.render();
            },

            /* ---------- GOALS MODULE ---------- */
            renderGoals(container) {
                const totalGoals = this.state.goals.length;
                const completedGoals = this.state.goals.filter(g => (g.current / g.target) >= 1).length;
                const completionRate = totalGoals ? Math.round((completedGoals / totalGoals) * 100) : 0;
                
                container.innerHTML = `
                    <div class="goals-header">
                        <h2>ğŸ¯ Ø§Ù‡Ø¯Ø§Ù Ù…Ù†</h2>
                        <div class="goals-stats">
                            <div class="glass-card" style="padding: 0.5rem 1rem;"><span style="color:var(--primary);">${completedGoals}</span> Ø§Ø² ${totalGoals} ØªÚ©Ù…ÛŒÙ„</div>
                            <div class="glass-card" style="padding: 0.5rem 1rem;">Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª <span style="color:var(--success);">${completionRate}%</span></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap:wrap;">
                        <input type="text" id="goalTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù" style="flex:2; min-width:200px; background:var(--input-bg); border:1px solid var(--surface-border); border-radius:10px; padding:0.8rem;">
                        <select id="goalCategory" style="flex:1; min-width:120px; background:var(--input-bg); border:1px solid var(--surface-border); border-radius:10px; padding:0.8rem;">
                            <option value="short">Ú©ÙˆØªØ§Ù‡ Ù…Ø¯Øª</option>
                            <option value="long">Ø¨Ù„Ù†Ø¯ Ù…Ø¯Øª</option>
                            <option value="life">Ø²Ù†Ø¯Ú¯ÛŒ</option>
                        </select>
                        <input type="date" id="goalDueDate" style="flex:1; min-width:140px; background:var(--input-bg); border:1px solid var(--surface-border); border-radius:10px; padding:0.8rem;">
                        <button class="btn btn-primary" onclick="app.addGoal()">â• Ø§ÙØ²ÙˆØ¯Ù† Ù‡Ø¯Ù</button>
                    </div>
                    <div id="goals-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;"></div>
                `;
                this.renderGoalsList();
            },

            renderGoalsList() {
                const list = document.getElementById('goals-list');
                if (!list) return;
                if (this.state.goals.length === 0) {
                    list.innerHTML = '<div class="glass-card" style="text-align:center;">ğŸ¯ Ù‡Ù†ÙˆØ² Ù‡Ø¯ÙÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ø§ÙˆÙ„ÛŒÙ† Ù‡Ø¯Ù Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯!</div>';
                    return;
                }
                list.innerHTML = this.state.goals.map(g => {
                    const percent = Math.min(100, Math.round((g.current / g.target) * 100));
                    const isCompleted = percent >= 100;
                    const dueDate = g.dueDate ? new Date(g.dueDate).toLocaleDateString('fa-IR') : 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÛŒØ®';
                    return `
                        <div class="glass-card goal-card ${isCompleted ? 'completed' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="font-size:1.2rem;">${g.title}</h3>
                                <span class="goal-tag">${g.category === 'short' ? 'Ú©ÙˆØªØ§Ù‡ Ù…Ø¯Øª' : g.category === 'long' ? 'Ø¨Ù„Ù†Ø¯ Ù…Ø¯Øª' : 'Ø²Ù†Ø¯Ú¯ÛŒ'}</span>
                            </div>
                            <div style="margin: 0.5rem 0; color:var(--text-secondary); font-size:0.85rem;">ğŸ“… ${dueDate}</div>
                            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                                <span>Ù¾ÛŒØ´Ø±ÙØª: ${g.current} / ${g.target}</span>
                                <span style="color:${percent >= 100 ? 'var(--success)' : 'var(--primary)'};">${percent}%</span>
                            </div>
                            <div class="goal-progress-container">
                                <div class="goal-progress-fill" style="width: ${percent}%;"></div>
                            </div>

                            <div class="goal-milestones">
                                ${g.milestones ? g.milestones.map((m, idx) => `
                                    <div class="milestone-item">
                                        <input type="checkbox" class="milestone-checkbox" data-goal="${g.id}" data-index="${idx}" ${m.completed ? 'checked' : ''} onchange="app.toggleMilestone('${g.id}', ${idx})">
                                        <span style="${m.completed ? 'text-decoration:line-through; opacity:0.6;' : ''}">${m.text}</span>
                                    </div>
                                `).join('') : ''}
                            </div>

                            <div class="goal-actions">
                                <button class="btn" style="padding:0.3rem 0.8rem;" onclick="app.addMilestonePrompt('${g.id}')">â• Ø²ÛŒØ±Ù‡Ø¯Ù</button>
                                <button class="btn" style="padding:0.3rem 0.8rem; background:var(--primary); color:white;" onclick="app.updateGoalProgress('${g.id}')">ğŸ“Š Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                                <button class="btn" style="padding:0.3rem 0.8rem; color:var(--accent);" onclick="app.deleteGoal('${g.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            addGoal() {
                const title = document.getElementById('goalTitle')?.value.trim();
                if (!title) { this.toast('Ø¹Ù†ÙˆØ§Ù† Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
                const category = document.getElementById('goalCategory')?.value || 'short';
                const dueDate = document.getElementById('goalDueDate')?.value || null;
                const newGoal = {
                    id: Date.now().toString(),
                    title,
                    category,
                    target: 100,
                    current: 0,
                    dueDate,
                    milestones: [],
                    createdAt: new Date().toISOString()
                };
                this.state.goals.push(newGoal);
                this.save();
                this.toast('Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                this.renderGoals(document.getElementById('app-view'));
            },

            updateGoalProgress(goalId) {
                const goal = this.state.goals.find(g => g.id === goalId);
                if (!goal) return;
                const newValue = prompt('Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ´Ø±ÙØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (0 ØªØ§ 100):', goal.current);
                if (newValue === null) return;
                const num = parseInt(newValue);
                if (isNaN(num) || num < 0 || num > 100) {
                    this.toast('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† Û° ØªØ§ Û±Û°Û° ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }
                goal.current = num;
                this.save();
                this.renderGoalsList();
                if (num >= goal.target) {
                    this.toast(`ğŸ‰ Ù‡Ø¯Ù "${goal.title}" ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!`, 'success');
                    this.playAlarm();
                }
            },

            addMilestonePrompt(goalId) {
                const goal = this.state.goals.find(g => g.id === goalId);
                if (!goal) return;
                const text = prompt('Ù…ØªÙ† Ø²ÛŒØ±Ù‡Ø¯Ù Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
                if (!text) return;
                if (!goal.milestones) goal.milestones = [];
                goal.milestones.push({ text, completed: false });
                this.save();
                this.renderGoalsList();
            },

            toggleMilestone(goalId, index) {
                const goal = this.state.goals.find(g => g.id === goalId);
                if (goal && goal.milestones && goal.milestones[index]) {
                    goal.milestones[index].completed = !goal.milestones[index].completed;
                    this.save();
                    const allCompleted = goal.milestones.every(m => m.completed);
                    if (allCompleted && goal.current < goal.target) {
                        goal.current = goal.target;
                        this.toast(`ğŸ¯ ØªÙ…Ø§Ù… Ø²ÛŒØ±Ù‡Ø¯Ùâ€ŒÙ‡Ø§ÛŒ "${goal.title}" Ú©Ø§Ù…Ù„ Ø´Ø¯!`, 'success');
                    }
                    this.renderGoalsList();
                }
            },

            deleteGoal(id) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‡Ø¯Ù Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    this.state.goals = this.state.goals.filter(g => g.id !== id);
                    this.save();
                    this.renderGoals(document.getElementById('app-view'));
                }
            },

            /* ---------- ENHANCED FOCUS MODULE ---------- */
            renderFocus(container) {
                const totalToday = this.totalFocusToday();
                const totalSessions = this.state.focusSessions.length;
                const avgDuration = totalSessions ? Math.round(this.state.focusSessions.reduce((a, s) => a + s.duration, 0) / totalSessions / 60) : 0;
                const recentSessions = this.state.focusSessions.slice(-5).reverse();

                const progressPercent = ((this.timer.totalSeconds - this.timer.timeLeft) / this.timer.totalSeconds) * 100;
                const currentMinutes = Math.floor(this.timer.totalSeconds / 60);
                const isPomodoro = currentMinutes === 25;
                const isLong = currentMinutes === 50;
                const isBreak = currentMinutes === 5;

                container.innerHTML = `
                    <div class="focus-container">
                        <h2 style="margin-bottom: 1rem;">ğŸ§˜ ØªÙ…Ø±Ú©Ø² Ø¹Ù…ÛŒÙ‚</h2>
                        <div class="glass-card">
                            <div class="xp-badge">âœ¨ Ø³Ø·Ø­ ØªÙ…Ø±Ú©Ø²: ${this.state.xp} XP</div>

                            <div class="focus-presets">
                                <button class="preset-btn ${isPomodoro ? 'active' : ''}" onclick="app.setFocusTime(25)">Ù¾ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ</button>
                                <button class="preset-btn ${isLong ? 'active' : ''}" onclick="app.setFocusTime(50)">ØªÙ…Ø±Ú©Ø² Ø·ÙˆÙ„Ø§Ù†ÛŒ</button>
                                <button class="preset-btn ${isBreak ? 'active' : ''}" onclick="app.setFocusTime(5)">Ø§Ø³ØªØ±Ø§Ø­Øª</button>
                            </div>

                            <div class="timer-display ${this.timer.running ? 'timer-running' : ''}" id="focusTimerDisplay">
                                ${this.formatTime(this.timer.timeLeft)}
                            </div>
                            <div class="timer-progress">
                                <div class="timer-progress-fill" id="focusProgressFill" style="width: ${progressPercent}%;"></div>
                            </div>

                            <div class="focus-options">
                                <select id="ambient-sound" class="btn" style="background: var(--surface);" onchange="app.toggleSound(this.value)">
                                    <option value="none">ğŸ”‡ Ø¨Ø¯ÙˆÙ† ØµØ¯Ø§</option>
                                    <option value="rain">ğŸŒ§ï¸ ØµØ¯Ø§ÛŒ Ø¨Ø§Ø±Ø§Ù†</option>
                                    <option value="white-noise">ğŸŒ«ï¸ Ù†ÙˆÛŒØ² Ø³ÙÛŒØ¯</option>
                                </select>
                            </div>

                            <div class="timer-controls">
                                <button class="btn btn-primary" id="startTimerBtn">${this.timer.running ? 'â¸ï¸ ØªÙˆÙ‚Ù' : 'â–¶ï¸ Ø´Ø±ÙˆØ¹'}</button>
                                <button class="btn" id="pauseTimerBtn">â¸ï¸ ØªÙˆÙ‚Ù Ù…ÙˆÙ‚Øª</button>
                                <button class="btn" id="resetTimerBtn">ğŸ”„ Ø±ÛŒØ³Øª</button>
                            </div>
                        </div>

                        <div class="session-stats">
                            <div class="session-card">
                                <div class="session-value" id="todayFocusValue">${Math.round(totalToday)}</div>
                                <div class="session-label">Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ù…Ø±ÙˆØ²</div>
                            </div>
                            <div class="session-card">
                                <div class="session-value" id="totalSessionsValue">${totalSessions}</div>
                                <div class="session-label">Ø¬Ù„Ø³Ø§Øª Ú©Ù„</div>
                            </div>
                            <div class="session-card">
                                <div class="session-value" id="avgDurationValue">${avgDuration}</div>
                                <div class="session-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† (Ø¯Ù‚ÛŒÙ‚Ù‡)</div>
                            </div>
                        </div>

                        <div class="glass-card">
                            <h3>ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† Ø¬Ù„Ø³Ø§Øª</h3>
                            <div class="session-list" id="sessionList">
                                ${recentSessions.map(s => `
                                    <div class="session-item">
                                        <span>${new Date(s.date).toLocaleDateString('fa-IR')} - ${new Date(s.date).toLocaleTimeString('fa-IR')}</span>
                                        <span style="color:var(--primary); font-weight:600;">${Math.round(s.duration/60)} Ø¯Ù‚ÛŒÙ‚Ù‡</span>
                                    </div>
                                `).join('')}
                                ${recentSessions.length === 0 ? '<p style="text-align:center; color:var(--text-secondary);">Ù‡Ù†ÙˆØ² Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>' : ''}
                            </div>
                        </div>
                    </div>
                    <audio id="ambient-audio" loop></audio>
                `;

                document.getElementById('startTimerBtn').onclick = () => {
                    if (this.timer.running) this.pauseTimer();
                    else this.startTimer();
                    this.renderFocus(container);
                };
                document.getElementById('pauseTimerBtn').onclick = () => this.pauseTimer();
                document.getElementById('resetTimerBtn').onclick = () => this.resetTimer();
            },

            setFocusTime(minutes) {
                this.pauseTimer();
                this.timer.totalSeconds = minutes * 60;
                this.timer.timeLeft = this.timer.totalSeconds;
                this.updateTimerDisplay();
                if (this.state.currentView === 'focus') {
                    this.renderFocus(document.getElementById('app-view'));
                }
            },

            toggleSound(type) {
                const audio = document.getElementById('ambient-audio');
                if (!audio) return;
                const sounds = {
                    'rain': 'https://www.soundjay.com/nature/rain-01.mp3',
                    'white-noise': 'https://www.soundjay.com/misc/sounds/white-noise-01.mp3'
                };
                
                if (type === 'none' || !sounds[type]) {
                    audio.pause();
                    audio.src = '';
                } else {
                    audio.src = sounds[type];
                    audio.play().catch(e => console.log("Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø®Ø´ ØµØ¯Ø§", e));
                }
            },

            startTimer() {
                if (this.timer.running) return;
                this.timer.running = true;
                this.timer.interval = setInterval(() => {
                    if (this.timer.timeLeft > 0) {
                        this.timer.timeLeft--;
                        this.updateTimerDisplay();
                    } else {
                        this.completeTimer();
                    }
                }, 1000);
                this.updateTimerDisplay();
            },

            pauseTimer() {
                this.timer.running = false;
                if (this.timer.interval) {
                    clearInterval(this.timer.interval);
                    this.timer.interval = null;
                }
                this.updateTimerDisplay();
            },

            resetTimer() {
                this.pauseTimer();
                this.timer.timeLeft = this.timer.totalSeconds;
                this.updateTimerDisplay();
            },

            completeTimer() {
                this.pauseTimer();
                const duration = this.timer.totalSeconds - this.timer.timeLeft;
                const session = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    duration: duration
                };
                this.state.focusSessions.push(session);
                this.state.focusTime += Math.round(duration / 60);
                this.state.xp += 10;
                this.save();
                this.toast('ğŸ‰ Ø²Ù…Ø§Ù† ØªÙ…Ø±Ú©Ø² Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯! Û±Û° XP Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯ÛŒØ¯', 'success');
                this.playAlarm();
                this.resetTimer();
                if (this.state.currentView === 'focus') {
                    this.render();
                }
            },

            updateTimerDisplay() {
                const display = document.getElementById('focusTimerDisplay');
                const progress = document.getElementById('focusProgressFill');
                if (display) display.innerText = this.formatTime(this.timer.timeLeft);
                if (progress) {
                    const percent = ((this.timer.totalSeconds - this.timer.timeLeft) / this.timer.totalSeconds) * 100;
                    progress.style.width = `${percent}%`;
                }
            },

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },

            totalFocusToday() {
                const today = new Date().toDateString();
                return this.state.focusSessions
                    .filter(s => new Date(s.date).toDateString() === today)
                    .reduce((acc, s) => acc + s.duration, 0) / 60;
            },

            /* ---------- STATS MODULE ---------- */
            renderStats(container) {
                container.innerHTML = `
                    <h2>ØªØ­Ù„ÛŒÙ„ Ø¢Ù…Ø§Ø±ÛŒ</h2>
                    <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-top: 2rem;">
                        <div class="glass-card">
                            <h3>ÙˆØ¶Ø¹ÛŒØª ÙˆØ¸Ø§ÛŒÙ</h3>
                            <canvas id="tasksChart"></canvas>
                        </div>
                        <div class="glass-card">
                            <h3>Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¹Ø§Ø¯Ø§Øª</h3>
                            <canvas id="habitsChart"></canvas>
                        </div>
                        <div class="glass-card" style="grid-column: span 2;">
                            <h3>Ø²Ù…Ø§Ù† ØªÙ…Ø±Ú©Ø² (Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±)</h3>
                            <canvas id="focusLineChart"></canvas>
                        </div>
                    </div>
                `;
                this.initStatsCharts();
            },

            initStatsCharts() {
                const ctxTasks = document.getElementById('tasksChart').getContext('2d');
                const done = this.state.tasks.filter(t => t.completed).length;
                const pending = this.state.tasks.length - done;

                new Chart(ctxTasks, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡', 'Ù…Ø§Ù†Ø¯Ù‡'],
                        datasets: [{
                            data: [done || 1, pending],
                            backgroundColor: ['#10b981', '#6366f1']
                        }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });

                const ctxFocus = document.getElementById('focusLineChart').getContext('2d');
                const last7Days = [];
                const labels = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toDateString();
                    labels.push(d.toLocaleDateString('fa-IR', { weekday: 'short' }));
                    const total = this.state.focusSessions
                        .filter(s => new Date(s.date).toDateString() === dateStr)
                        .reduce((acc, s) => acc + s.duration, 0) / 60;
                    last7Days.push(total);
                }

                new Chart(ctxFocus, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø²',
                            data: last7Days,
                            borderColor: '#6366f1',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)'
                        }]
                    }
                });
            },

            /* ---------- WEEKLY PLANNER (24 hours) ---------- */
            renderWeekly(container) {
                const days = ['Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡'];
                const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);

                container.innerHTML = `
                    <div class="glass-card">
                        <h2>ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ù‡ÙØªÚ¯ÛŒ (Û²Û´ Ø³Ø§Ø¹ØªÙ‡)</h2>
                        <p style="font-size:0.8rem; color:gray; margin-bottom:10px;">Ù†Ú©ØªÙ‡: Ù…ØªÙ† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ ØªØ§ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯.</p>
                        <div class="sheet-outer-container">
                            <table class="weekly-table">
                                <thead>
                                    <tr>
                                        <th class="time-label">Ø³Ø§Ø¹Øª</th>
                                        ${days.map(d => `<th>${d}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${hours.map(h => `
                                        <tr>
                                            <td class="time-label">${h}</td>
                                            ${days.map(d => {
                                                const id = `${d}-${h}`;
                                                const val = this.state.weeklyData[id] || '';
                                                return `<td>
                                                    <input class="cell-input" 
                                                        value="${val}" 
                                                        onchange="app.updateSheet('${id}', this.value)"
                                                        placeholder="...">
                                                </td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            updateSheet(id, value) {
                this.state.weeklyData[id] = value;
                this.save();
                this.toast("Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯", "success");
            },

            /* ---------- ASSISTANT (SUPER INTELLIGENT) ---------- */
            toggleChat() {
                const win = document.getElementById('chat-window');
                win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
                if (win.style.display === 'flex') {
                    document.getElementById('chat-input').focus();
                }
            },

            sendChatMessage() {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                if (!msg) return;

                const chatMessages = document.getElementById('chat-messages');
                // Add user message
                const userDiv = document.createElement('div');
                userDiv.className = 'message user';
                userDiv.innerHTML = `<div class="bubble">${msg}</div>`;
                chatMessages.appendChild(userDiv);

                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = '<span></span><span></span><span></span>';
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Process after a short delay
                setTimeout(() => {
                    // Remove typing indicator
                    chatMessages.removeChild(typingDiv);

                    const reply = this.processCommand(msg);

                    const botDiv = document.createElement('div');
                    botDiv.className = 'message bot';
                    botDiv.innerHTML = `<div class="bubble">${reply}</div>`;
                    chatMessages.appendChild(botDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 600);

                input.value = '';
            },

            // ---------- HELPER: Levenshtein distance for fuzzy matching ----------
            levenshtein(a, b) {
                const matrix = [];
                for (let i = 0; i <= b.length; i++) matrix[i] = [i];
                for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i-1) === a.charAt(j-1)) {
                            matrix[i][j] = matrix[i-1][j-1];
                        } else {
                            matrix[i][j] = Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
                        }
                    }
                }
                return matrix[b.length][a.length];
            },

            // Normalize Persian text: remove diacritics, normalize Ùƒ and ÙŠ
            normalize(text) {
                return text
                    .replace(/[Ù‹ÙŒÙÙÙÙÙ‘Ù’]/g, '')
                    .replace(/[ÙŠÙ‰]/g, 'ÛŒ')
                    .replace(/[Ùƒ]/g, 'Ú©')
                    .replace(/\s+/g, ' ')
                    .trim();
            },

            // ---------- ADVANCED PROCESS COMMAND WITH CONTEXT AND FOLLOW-UPS ----------
            processCommand(input) {
                const normalized = this.normalize(input);
                const words = normalized.split(/\s+/);

                // Add to conversation history (keep last 5)
                this.conversationHistory.push({ role: 'user', text: normalized });
                if (this.conversationHistory.length > 5) this.conversationHistory.shift();

                // Check for follow-ups using context
                if (this.lastIntent && (normalized.includes('Ø¨Ø¹Ø¯ÛŒ') || normalized.includes('Ø¨Ø¹Ø¯') || normalized.includes('Ø¨Ø¹Ø¯Ø´'))) {
                    if (this.lastIntent === 'weekly_today') {
                        const response = this.handleWeeklyTomorrow();
                        this.conversationHistory.push({ role: 'bot', text: response });
                        return response;
                    }
                }

                // Check for command patterns (adding tasks, habits, etc.)
                if (normalized.includes('Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†') || normalized.includes('Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†') || normalized.includes('Ø¨Ø³Ø§Ø²')) {
                    if (normalized.includes('ØªØ³Ú©') || normalized.includes('ÙˆØ¸ÛŒÙÙ‡') || normalized.includes('Ú©Ø§Ø±')) {
                        let title = normalized.replace(/.*?(Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†|Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†|Ø¨Ø³Ø§Ø²)\s*(ØªØ³Ú©|ÙˆØ¸ÛŒÙÙ‡|Ú©Ø§Ø±)\s*/i, '').trim();
                        if (title) {
                            this.addTask(title);
                            const response = `âœ… ÙˆØ¸ÛŒÙÙ‡ "${title}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                            this.conversationHistory.push({ role: 'bot', text: response });
                            return response;
                        } else {
                            return "Ù„Ø·ÙØ§ Ù…ØªÙ† ÙˆØ¸ÛŒÙÙ‡ Ø±Ø§ Ù‡Ù… Ø¨Ù†ÙˆÛŒØ³.";
                        }
                    } else if (normalized.includes('Ø¹Ø§Ø¯Øª')) {
                        let name = normalized.replace(/.*?(Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†|Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†|Ø¨Ø³Ø§Ø²)\s*(Ø¹Ø§Ø¯Øª)\s*/i, '').trim();
                        if (name) {
                            this.addHabitFromAssistant(name);
                            const response = `ğŸ”¥ Ø¹Ø§Ø¯Øª "${name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                            this.conversationHistory.push({ role: 'bot', text: response });
                            return response;
                        } else {
                            return "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¹Ø§Ø¯Øª Ø±Ø§ Ù‡Ù… Ø¨Ù†ÙˆÛŒØ³.";
                        }
                    }
                }

                // Define intents with keywords and response generators
                const intents = [
                    {
                        name: 'tasks_pending',
                        keywords: ['ØªØ³Ú©', 'ÙˆØ¸ÛŒÙÙ‡', 'Ú©Ø§Ø±'],
                        handler: () => {
                            const pending = this.state.tasks.filter(t => !t.completed).length;
                            const total = this.state.tasks.length;
                            if (total === 0) return "ğŸ“­ Ø´Ù…Ø§ Ù‡ÛŒÚ† ÙˆØ¸ÛŒÙÙ‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.";
                            return `ğŸ“‹ Ø´Ù…Ø§ ${total} ÙˆØ¸ÛŒÙÙ‡ Ø¯Ø§Ø±ÛŒ Ú©Ù‡ ${pending} ØªØ§Ø´ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡.`;
                        }
                    },
                    {
                        name: 'tasks_completed_today',
                        keywords: ['Ø§Ù…Ø±ÙˆØ²', 'Ú†Ù†Ø¯', 'ØªØ³Ú©', 'Ø§Ù†Ø¬Ø§Ù…'],
                        handler: () => {
                            const today = new Date().toDateString();
                            const completedToday = this.state.tasks.filter(t => t.completed && new Date(t.completedAt || 0).toDateString() === today).length;
                            return `âœ… Ø§Ù…Ø±ÙˆØ² ${completedToday} ØªØ³Ú© Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒ.`;
                        }
                    },
                    {
                        name: 'last_task',
                        keywords: ['Ø¢Ø®Ø±ÛŒÙ†', 'ØªØ³Ú©', 'ÙˆØ¸ÛŒÙÙ‡', 'Ø§Ù†Ø¬Ø§Ù…'],
                        handler: () => {
                            const lastTask = this.state.tasks.filter(t => t.completed).pop();
                            if (lastTask) return `ğŸ”š Ø¢Ø®Ø±ÛŒÙ† Ú©Ø§Ø±ÛŒ Ú©Ù‡ ØªÛŒÚ© Ø²Ø¯ÛŒ: "${lastTask.title}" Ø¨ÙˆØ¯.`;
                            return "Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ³Ú©ÛŒ Ø±Ùˆ Ú©Ø§Ù…Ù„ Ù†Ú©Ø±Ø¯ÛŒ.";
                        }
                    },
                    {
                        name: 'habits_today',
                        keywords: ['Ø¹Ø§Ø¯Øª', 'Ø§Ù…Ø±ÙˆØ²', 'Ú†Ù†Ø¯'],
                        handler: () => {
                            const completed = this.state.habits.filter(h => h.completedToday).length;
                            const total = this.state.habits.length;
                            if (total === 0) return "ğŸ“­ Ù‡ÛŒÚ† Ø¹Ø§Ø¯ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.";
                            return `ğŸ”¥ Ø§Ù…Ø±ÙˆØ² ${completed} Ø§Ø² ${total} Ø¹Ø§Ø¯Øª Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒ.`;
                        }
                    },
                    {
                        name: 'goals_count',
                        keywords: ['Ù‡Ø¯Ù', 'Ú†Ù†Ø¯'],
                        handler: () => {
                            const total = this.state.goals.length;
                            const completed = this.state.goals.filter(g => g.current >= g.target).length;
                            return `ğŸ¯ Ø´Ù…Ø§ ${total} Ù‡Ø¯Ù Ø¯Ø§Ø±ÛŒ Ú©Ù‡ ${completed} ØªØ§Ø´ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡.`;
                        }
                    },
                    {
                        name: 'xp',
                        keywords: ['xp', 'Ø§Ù…ØªÛŒØ§Ø²'],
                        handler: () => `âœ¨ Ø´Ù…Ø§ ${this.state.xp} Ø§Ù…ØªÛŒØ§Ø² XP Ø¯Ø§Ø±ÛŒ.`
                    },
                    {
                        name: 'focus_today',
                        keywords: ['ØªÙ…Ø±Ú©Ø²', 'Ø§Ù…Ø±ÙˆØ²', 'Ú†Ù†Ø¯'],
                        handler: () => {
                            const minutes = this.totalFocusToday();
                            return `â±ï¸ Ø§Ù…Ø±ÙˆØ² ${Math.round(minutes)} Ø¯Ù‚ÛŒÙ‚Ù‡ ØªÙ…Ø±Ú©Ø² Ø¯Ø§Ø´ØªÛŒ.`;
                        }
                    },
                    {
                        name: 'reminders_today',
                        keywords: ['ÛŒØ§Ø¯Ø¢ÙˆØ±', 'Ø§Ù…Ø±ÙˆØ²', 'Ú†Ù†Ø¯'],
                        handler: () => {
                            const todayReminders = this.state.reminders;
                            if (todayReminders.length === 0) return "â° Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ù†Ø¯Ø§Ø±ÛŒ.";
                            return `â° ${todayReminders.length} ÛŒØ§Ø¯Ø¢ÙˆØ± Ø¯Ø§Ø±ÛŒ: ${todayReminders.map(r => r.text).join('ØŒ ')}`;
                        }
                    },
                    {
                        name: 'weekly_today',
                        keywords: ['Ø¨Ø±Ù†Ø§Ù…Ù‡', 'Ø§Ù…Ø±ÙˆØ²', 'Ú†ÛŒ'],
                        handler: () => {
                            const todayName = new Intl.DateTimeFormat('fa-IR', { weekday: 'long' }).format(new Date());
                            const today = this.getWeekdayName(todayName);
                            const tasksToday = Object.entries(this.state.weeklyData)
                                .filter(([key]) => key.startsWith(today))
                                .map(([_, val]) => val)
                                .filter(v => v.trim() !== "");
                            const response = tasksToday.length > 0 
                                ? `ğŸ“… Ø§Ù…Ø±ÙˆØ² ${today} Ø§ÛŒÙ† Ú©Ø§Ø±Ù‡Ø§ Ø±Ùˆ Ø¯Ø§Ø±ÛŒ: ${tasksToday.join('ØŒ ')}`
                                : `ğŸ“… Ø§Ù…Ø±ÙˆØ² ${today} Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§ØµÛŒ Ù†Ø¯Ø§Ø±ÛŒ.`;
                            this.lastIntent = 'weekly_today';
                            return response;
                        }
                    },
                    {
                        name: 'weekly_tomorrow',
                        keywords: ['Ø¨Ø±Ù†Ø§Ù…Ù‡', 'ÙØ±Ø¯Ø§', 'Ú†ÛŒ'],
                        handler: () => {
                            return this.handleWeeklyTomorrow();
                        }
                    },
                    {
                        name: 'notes_search',
                        keywords: ['ÛŒØ§Ø¯Ø¯Ø§Ø´Øª', 'Ø¯Ø±Ø¨Ø§Ø±Ù‡', 'Ø¬Ø³ØªØ¬Ùˆ'],
                        handler: (input) => {
                            const query = input.replace(/ÛŒØ§Ø¯Ø¯Ø§Ø´Øª|Ø¯Ø±Ø¨Ø§Ø±Ù‡|Ø¬Ø³ØªØ¬Ùˆ/gi, '').trim();
                            if (!query) return "Ú†ÛŒ Ø±Ùˆ Ø¯Ø± ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†Ù…ØŸ";
                            const found = this.state.notes.filter(n => n.title.includes(query) || n.content.includes(query));
                            if (found.length === 0) return `âŒ Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ "${query}" Ù¾ÛŒØ¯Ø§ Ù†Ú©Ø±Ø¯Ù….`;
                            return `ğŸ“ ${found.length} ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù…. Ù…Ø«Ù„Ø§Ù‹: "${found[0].title}"`;
                        }
                    },
                    {
                        name: 'summary',
                        keywords: ['Ø®Ù„Ø§ØµÙ‡', 'Ø§Ù…Ø±ÙˆØ²', 'Ú¯Ø²Ø§Ø±Ø´'],
                        handler: () => {
                            const tasksPending = this.state.tasks.filter(t => !t.completed).length;
                            const habitsCompleted = this.state.habits.filter(h => h.completedToday).length;
                            const focusMinutes = Math.round(this.totalFocusToday());
                            const xp = this.state.xp;
                            return `ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø§Ù…Ø±ÙˆØ²:\nâœ… ÙˆØ¸Ø§ÛŒÙ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡: ${tasksPending}\nğŸ”¥ Ø¹Ø§Ø¯Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: ${habitsCompleted}\nâ±ï¸ ØªÙ…Ø±Ú©Ø²: ${focusMinutes} Ø¯Ù‚ÛŒÙ‚Ù‡\nâœ¨ XP: ${xp}`;
                        }
                    }
                ];

                // Fuzzy match keywords to find best intent
                let bestIntent = null;
                let bestScore = 0;
                for (const intent of intents) {
                    let score = 0;
                    for (const kw of intent.keywords) {
                        for (const word of words) {
                            const dist = this.levenshtein(kw, word);
                            if (dist <= 1) {
                                score += 2;
                            } else if (word.includes(kw) || kw.includes(word)) {
                                score += 1;
                            }
                        }
                    }
                    if (score > bestScore) {
                        bestScore = score;
                        bestIntent = intent;
                    }
                }

                if (bestIntent && bestScore > 0) {
                    this.lastIntent = bestIntent.name;
                    const response = bestIntent.handler(input);
                    this.conversationHistory.push({ role: 'bot', text: response });
                    return response;
                }

                // Check if it's a follow-up about "Ø¨Ø¹Ø¯ÛŒ" without context
                if (normalized.includes('Ø¨Ø¹Ø¯ÛŒ') || normalized.includes('Ø¨Ø¹Ø¯')) {
                    return "Ù…Ù†Ø¸ÙˆØ±Øª Ú†ÛŒÙ‡ØŸ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¨Ù¾Ø±Ø³ÛŒ 'Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ±Ø¯Ø§' ÛŒØ§ 'Ø¨Ø¹Ø¯ÛŒ' Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ ÛŒÙ‡ Ú†ÛŒØ²ÛŒ Ù¾Ø±Ø³ÛŒØ¯ÛŒ.";
                }

                // Default fallback
                const fallback = "ğŸ¤” Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…. Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ ØªØ³Ú©â€ŒÙ‡Ø§ØŒ Ø¹Ø§Ø¯Ø§ØªØŒ Ø§Ù‡Ø¯Ø§ÙØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒØŒ ÛŒØ§Ø¯Ø¢ÙˆØ±Ù‡Ø§ØŒ ØªÙ…Ø±Ú©Ø² Ùˆ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø§Ø² Ù…Ù† Ø¨Ù¾Ø±Ø³ÛŒ.";
                this.conversationHistory.push({ role: 'bot', text: fallback });
                return fallback;
            },

            handleWeeklyTomorrow() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowName = new Intl.DateTimeFormat('fa-IR', { weekday: 'long' }).format(tomorrow);
                const tomorrowKey = this.getWeekdayName(tomorrowName);
                const tasksTomorrow = Object.entries(this.state.weeklyData)
                    .filter(([key]) => key.startsWith(tomorrowKey))
                    .map(([_, val]) => val)
                    .filter(v => v.trim() !== "");
                return tasksTomorrow.length > 0 
                    ? `ğŸ“… ÙØ±Ø¯Ø§ ${tomorrowName} Ø§ÛŒÙ† Ú©Ø§Ø±Ù‡Ø§ Ø±Ùˆ Ø¯Ø§Ø±ÛŒ: ${tasksTomorrow.join('ØŒ ')}`
                    : `ğŸ“… ÙØ±Ø¯Ø§ ${tomorrowName} Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø®Ø§ØµÛŒ Ù†Ø¯Ø§Ø±ÛŒ.`;
            },

            getWeekdayName(faName) {
                const map = {
                    "Ø´Ù†Ø¨Ù‡": "Ø´Ù†Ø¨Ù‡",
                    "ÛŒÚ©Ø´Ù†Ø¨Ù‡": "ÛŒÚ©Ø´Ù†Ø¨Ù‡",
                    "Ø¯ÙˆØ´Ù†Ø¨Ù‡": "Ø¯ÙˆØ´Ù†Ø¨Ù‡",
                    "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡": "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡",
                    "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡": "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡",
                    "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡": "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡",
                    "Ø¬Ù…Ø¹Ù‡": "Ø¬Ù…Ø¹Ù‡"
                };
                return map[faName] || faName;
            },

            addHabitFromAssistant(name) {
                if (!name) return;
                const newHabit = { id: Date.now(), name, streak: 0, completedToday: false, lastDone: null };
                this.state.habits.push(newHabit);
                this.save();
                this.toast('Ø¹Ø§Ø¯Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                if (this.state.currentView === 'habits') this.renderHabitsList();
            },

            /* ---------- CORE UTILITIES ---------- */
            addTask(title) {
                if(!title) return;
                this.state.tasks.push({ id: Date.now(), title, completed: false, priority: 'medium', completedAt: null });
                this.save();
                this.render();
                this.toast('ÙˆØ¸ÛŒÙÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            },

            toggleTask(id) {
                const t = this.state.tasks.find(t => t.id === id);
                if(t) {
                    t.completed = !t.completed;
                    t.completedAt = t.completed ? new Date().toISOString() : null;
                }
                this.save();
                this.render();
            },

            deleteTask(id) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ¸ÛŒÙÙ‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    this.state.tasks = this.state.tasks.filter(t => t.id !== id);
                    this.save();
                    this.render();
                }
            },

            calculateProductivityScore() {
                if (this.state.tasks.length === 0) return 0;
                const taskRatio = (this.state.tasks.filter(t => t.completed).length / this.state.tasks.length) * 100;
                return Math.round(taskRatio);
            },

            animateValue(id, start, end, duration) {
                const obj = document.getElementById(id);
                if (!obj) return;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = Math.floor(progress * (end - start) + start);
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            },

            toggleTheme() {
                const body = document.body;
                const isDark = body.getAttribute('data-theme') === 'dark';
                body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            },

            toast(msg, type = '') {
                const t = document.createElement('div');
                t.style.cssText = `position:fixed; bottom:20px; left:20px; background:${type === 'success' ? 'var(--success)' : 'var(--primary)'}; color:white; padding:12px 24px; border-radius:10px; z-index:9999; animation:fadeIn 0.3s ease;`;
                t.innerText = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            },

            startClock() {
                setInterval(() => {
                    const el = document.getElementById('clock');
                    if(el) el.innerText = new Date().toLocaleTimeString('fa-IR');
                }, 1000);
            },

            startReminderChecker() {
                if (this.alarmInterval) clearInterval(this.alarmInterval);
                this.alarmInterval = setInterval(() => {
                    this.checkReminders();
                }, 60000);
            },

            checkReminders() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                this.state.reminders.forEach(rem => {
                    const [hour, minute] = rem.time.split(':').map(Number);
                    if (hour === currentHour && minute === currentMinute) {
                        this.playAlarm();
                        this.toast(`ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±: ${rem.text}`, 'success');
                        this.sendTelegramMessage(rem.text); 
                        this.deleteReminder(rem.id, false);
                    }
                });
            },

            sendTelegramMessage(text) {
                const botToken = '8348342500:AAGbQWfr4LhvB3HZRWFZjv_GIVlMXAhnDIw';
                const chatId = '832244920';
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, text: `ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ø² ZENITH OS:\n\n${text}` })
                }).catch(err => console.error('Telegram Error:', err));
            },

            playAlarm() {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    oscillator.start();
                    oscillator.stop(audioCtx.currentTime + 0.5);
                } catch (e) {
                    console.warn('Web Audio not supported', e);
                }
            },

            attachEvents() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.onclick = (e) => {
                        const view = e.currentTarget.dataset.view;
                        if (view) {
                            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                            e.currentTarget.classList.add('active');
                            this.state.currentView = view;
                            this.render();
                        }
                    };
                });

                window.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        document.getElementById('cmd-palette').classList.add('open');
                        document.getElementById('cp-input').focus();
                    }
                    if (e.key === 'Escape') {
                        document.getElementById('cmd-palette').classList.remove('open');
                        // also close chat if open
                        const chat = document.getElementById('chat-window');
                        if (chat.style.display === 'flex') chat.style.display = 'none';
                        this.closeDrawer();
                    }
                });

                document.getElementById('cp-input').onkeypress = (e) => {
                    if(e.key === 'Enter') {
                        const cmd = e.target.value;
                        if(cmd.startsWith('Ø§ÙØ²ÙˆØ¯Ù† ')) {
                            this.addTask(cmd.replace('Ø§ÙØ²ÙˆØ¯Ù† ', ''));
                        }
                        e.target.value = '';
                        document.getElementById('cmd-palette').classList.remove('open');
                    }
                };
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>